<!DOCTYPE html>
<html lang="ru" xml:lang="ru" xmlns="http://www.w3.org/1999/xhtml">

<head>

	<title>Коктейли | Печать</title>
	<link rel="icon" type="image/svg+xml" href="/favicon.svg" />

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />

	<style media="all">

		@page {
			size: 450mm 320mm;
			margin: 0;
		}

		@font-face {
			font-family: "Open Sans Condensed";
			src: local( "Open Sans Condensed Bold" ),
				 url( "/@/OpenSansCondensed-Bold.ttf" );
		}

		@font-face {
			font-family: "Open Sans Condensed Light";
			src: local( "Open Sans Condensed Light" ),
				 url( "/@/OpenSansCondensed-Light.ttf" );
		}

		*,
		:after,
		:before {
			margin: 0;
			padding: 0;
			border: 0;
		}

		ul {
			list-style-type: none;
		}

		body {
			font-family: "Open Sans Condensed Light", Arial, sans-serif;
			width: 450mm;
			height: calc( 640mm - 2mm );
			-webkit-print-color-adjust: exact !important;
		}

		.page {

			--ratio: 1;

			display: grid;
			grid-template-columns: repeat( 4, calc( 450mm / 4 - 16mm ) );
			grid-auto-rows: calc( 320mm - 17mm );
			grid-gap: 16mm;
			padding: 8mm;

			page-break-before: always;

		}

		.page > * {
			overflow: hidden;
		}

		.bold {
			font-family: "Open Sans Condensed", Arial, sans-serif;
			text-transform: uppercase;
		}

		.ml:empty {
			display: none;
		}

		.ml:after {
			content: "ml";
		}

		.nowrap {
			white-space: nowrap;
		}

		.opacity {
			opacity: 0.6;
		}

		.opacity .opacity {
			opacity: 1;
		}

		.title {
			font-size: calc( 23pt * var( --ratio ) );
			line-height: calc( 23pt * var( --ratio ) );
		}

		.sub-text {
			font-size: calc( 12pt * var( --ratio ) );
		}

		.section {

			display: grid;
			grid-template-columns: auto;
			grid-gap: calc( 4pt * var( --ratio ) * var( --ratio ) ) 4pt;

			font-size: calc( 13.2pt * var( --ratio ) );

			box-sizing: content-box;

			margin: 0 3mm;

		}

		.section:not( :last-of-type ) {
			padding-bottom: calc( 12pt * var( --ratio ) * var( --ratio ) * var( --ratio ) * var( --ratio ) );
		}

		.section > ul {
			grid-column-start: 1;
			grid-column-end: 3;
		}

		.item {
			display: grid;
			grid-template-columns: auto min-content 11mm;
			grid-gap: 0 2mm;
		}

		.item > ul {
			margin-left: 6mm;
			grid-column-start: 1;
			grid-column-end: 3;
		}

		.item > div {
			justify-content: space-between;
			display: inline;
			line-height: calc( 16pt * var( --ratio ) * var( --ratio ) );
		}

		.item > div + div {
			text-align: right;
		}

		.price > span + span {
			font-size: calc( 11pt * var( --ratio ) );
		}

		.price > span + span:not( :empty ):before {
			content: ".";
		}

		.section.coctails {
			grid-template-columns: max-content 18mm;
		}

		.section.coctails .title:after {
			content: "";
			display: block;
			width: 100%;
			height: 0.5mm;
			line-height: 0.5mm;
			background: #000;
			margin-top: 2mm;
		}

		.cocktail {

			--color: #000;
			--scale: 1;

			font-size: 13pt;
			line-height: 13pt;

			position: relative;
			display: grid;
			grid-template-columns: auto 72mm;
			width: 100%;
			min-height: 22mm;

			margin: 0 -3mm calc( 3.8mm * var( --ratio ) ) -3mm;

		}

		.cocktail .name {
			font-size: 14pt;
			line-height: 13pt;
			padding-right: 5mm;
			margin-bottom: 1mm;
		}

		.cocktail .price:before {
			content: "";
			display: block;
			width: 52mm;
			height: 0.8mm;
			background: var( --color );
			position: absolute;
			left: -51mm;
		}

		.cocktail .container {
			height: 1mm;
			position: relative;
		}

		.cocktail .container > * {
			display: block;
			position: absolute;
			right: 3.5mm;
			width: 18mm;
			text-align: center;
		}

		.cocktail .price {
			font-size: 16pt;
			line-height: 7mm;
			width: 18mm;
			height: 7mm;
			text-align: center;
			color: #fff;
		}

		.cocktail .price > span + span {
			font-size: 12pt;
		}

		.cocktail .container svg {
			position: absolute;
			left: 0;
			top: 0;
			z-index: -1;
		}

		.cocktail .container polygon {
			fill: var( --color );
		}

		.cocktail .cap {
			top: 8.5mm;
		}

		.cocktail .mix {
			padding-right: 26mm;
			margin-bottom: 2mm;
		}

		.cocktail .img {
			width: 24mm;
			position: relative;
		}

		.cocktail .img img {
			width: 24mm;
			position: absolute;
			top: 50%;
			left: 50%;
			transform-origin: 50% 50%;
			transform: translate( -50%, -50% );
		}

		.cocktail:nth-child( 2n ) {
			--scale: -1;
		}

		.cocktail:nth-child( 2n ) > div {
			position: relative;
			left: -24.5mm;
			text-align: right;
		}

		.cocktail:nth-child( 2n ) .img {
			left: 72mm;
			text-align: center;
		}

		.cocktail:nth-child( 2n ) .name {
			padding: 0 0 0 20mm;
		}

		.cocktail:nth-child( 2n ) .container {
			padding: 0 0 0 3.5mm;
			text-align: left;
		}

		.cocktail:nth-child( 2n ) .price:before {
			left: auto;
			right: -51mm;
		}

		.cocktail:nth-child( 2n ) .container > * {
			right: auto;
		}

		.cocktail:nth-child( 2n ) .container svg {
			transform: scaleX( -1 );
		}

		.cocktail:nth-child( 2n ) .mix {
			padding: 0 0 0 26mm;
		}

		@media screen {

			.page {
				outline: 1px solid #555;
				position: relative;
			}

			.page > div:not( :nth-child( 1 ) ) {
				display: none;
			}

			.page:before {
				content: "";
				display: block;
				position: absolute;
				top: 8mm;
				bottom: 8mm;
				left: 8mm;
				width: calc( 450mm / 4 - 16mm );
				outline: 1mm dashed #f99;
				pointer-events: none;
			}

		}

	</style>

	<template id="cocktail-section">
		<div class="section coctails">
			<div class="title bold">Коктейли</div>
			<div class="logo"><img src="/@/logo.svg" style="width:18mm;height:auto;filter:invert(1)" /></div>
			<ul></ul>
		</div>
	</template>

	<template id="section">
		<div class="section">
			<div class="title bold"></div>
			<div></div>
			<ul></ul>
		</div>
	</template>

	<template id="cocktail">
		<li class="cocktail">
			<div class="img"></div>
			<div>
				<div class="name bold"></div>
				<div class="container">
					<span>
						<svg xmlns="http://www.w3.org/2000/svg" width="18mm" height="7mm" viewBox="0 0 18 7">
							<polygon points="0,0 2.5,3.5 0,7 15.5,7 18,3.5 15.5,0"/>
						</svg>
					</span>
					<div class="cap opacity sub-text ml"></div>
				</div>
				<div class="mix"></div>
			</div>
		</li>
	</template>

	<template id="drink">
		<li class="item drink">
			<div><span class="name"></span></div>
			<div class="opacity sub-text nowrap"></div>
			<div class="nowrap"></div>
		</li>
	</template>

	<template id="price">
		<span class="price bold"><span></span><span></span></span>
	</template>

	<template id="ml">
		<span class="ml"></span>
	</template>

</head>

<body>

<article class="page">
	<div></div>
</article>

<article class="page">
	<div></div>
</article>

<script type="module">

	import iiko from '/@/iiko.max.mjs';
	import { FastAverageColor } from 'https://unpkg.com/fast-average-color/dist/index.esm.js';

	const fac = new FastAverageColor();

	const params = new URLSearchParams( location.search );

	/** @type { string } */
	const lang = params.has( 'en' ) ? 'en' : 'ru';

	/**
	 * @param { { ru?: string, en?: string } } data
	 * @returns { string }
	 */
	const getName = ( data ) =>
		data[ lang ] || data.ru
	;

	const cocktailSectionTemplate =	document.querySelector( '#cocktail-section' );
	const sectionTemplate =			document.querySelector( '#section' );

	const priceTemplate =			document.querySelector( '#price' );
	const mlTemplate =				document.querySelector( '#ml' );

	const cocktailTemplate =		document.querySelector( '#cocktail' );
	const drinkTemplate =			document.querySelector( '#drink' );

	const createCoctailSection = async () => {
		return cocktailSectionTemplate.content.cloneNode( true ).querySelector( '.section' );
	};

	/**
	 * @param { Product } product
	 * @returns { Promise< Node > }
	 */
	const createCocktailProduct = async ( product ) => {

		let v;

		let result = cocktailTemplate.content.cloneNode( true );

		try {

			let img = await new Promise( ( resolve, reject ) => {
				const img = new Image();
				img.setAttribute( 'crossorigin', 'anonymous' );
				img.setAttribute( 'src', 'https://wsrv.nl/?url=' + encodeURIComponent( product.img ) );
				img.addEventListener( 'load', () => resolve( img ), { once: true } );
				img.addEventListener( 'error', reject )
			} );

			result.querySelector( 'li' ).style.setProperty( '--color', ( await fac.getColorAsync( img, {
				ignoredColor: [
					[ 0, 0, 0, 255, 33 ],
					[ 255, 255, 255, 255, 128 ],
				],
			} ) ).hex );

			result.querySelector( '.img' ).appendChild( img );

		} catch ( e ) {

		}

		if ( ( v = product?.units[ 0 ]?.price ) ) {
			result.querySelector( '.container span ' ).appendChild( await createPrice( v ) );
		}

		if ( ( v = product?.units[ 0 ]?.size ) ) {
			result.querySelector( '.cap' ).textContent = v;
		}

		result.querySelector( '.name' ).textContent = product.ru;
		result.querySelector( '.mix' ).textContent = product.desc.split( /\s*,\s*/g ).map( ( d ) => d.replace( /\s+/g, ' ' ) ).join( ', ' );

		return result;

	};

	/**
	 * @param { Product } product
	 * @returns { Promise< Node > }
	 */
	const createDrinkProduct = async ( product ) => {

		let v;

		let result = drinkTemplate.content.cloneNode( true );
		let li = result.querySelector( 'li' );

		li.querySelector( '.name' ).textContent = getName( product );

		if ( ( v = product?.units[ 0 ]?.size ) ) {
			li.querySelector( 'div:nth-child( 2 )' ).appendChild( await createML( v ) );
		}
		if ( ( v = product?.units[ 0 ]?.price ) ) {
			li.querySelector( 'div:last-of-type' ).appendChild( await createPrice( v ) );
		}

		return result;

	};

	/**
	 * @param { Group } group
	 * @returns { Promise< Node > }
	 */
	const createDrinkGroup = async ( group ) => {

		let result = sectionTemplate.content.cloneNode( true );

		result.querySelector( '.title' ).textContent = getName( group );

		if ( group.products ) {

			for ( let product of group.products ) {
				result.querySelector( 'ul' ).appendChild( await createDrinkProduct( product ) );
			}

		}

		return result;

	};

	/**
	 * @param { number } price
	 * @returns { Promise< Node > }
	 */
	const createPrice = async ( price ) => {

		const result = priceTemplate.content.cloneNode( true );
		const span = result.querySelectorAll( '.price span' );

		const c = ( price / 100 ).toFixed( 2 ).split( '.' );

		span[ 0 ].textContent = c[ 0 ];
		span[ 1 ].textContent = c[ 1 ];

		return result;

	};

	/**
	 * @param { number } size
	 * @returns { Promise< Node > }
	 */
	const createML = async ( size ) => {

		let result = mlTemplate.content.cloneNode( true );
		result.querySelector( 'span' ).textContent = size;
		return result;

	};

	const Coctails = await iiko( '7c2c8997-e3f6-4744-a79a-8080e70c505f' );

	const page = document.querySelectorAll( '.page' );
	const colon = document.querySelectorAll( '.page>div' );

	const ul0 = colon[ 0 ].appendChild( await createCoctailSection() ).querySelector( 'ul' );
	const ul1 = colon[ 1 ].appendChild( await createCoctailSection() ).querySelector( 'ul' );

	let i = 0;

	do {
		ul0.appendChild( await createCocktailProduct( Coctails.products[ i++ ] ) );
	} while ( ul0.clientHeight < 1020 && i < Coctails.products.length );

	do {
		ul1.appendChild( await createCocktailProduct( Coctails.products[ i++ ] ) );
	} while ( i < Coctails.products.length );

	colon[ 1 ].appendChild( await createDrinkGroup( Coctails?.groups?.ClassicCocktails ) );

	// coctails0.insertAdjacentHTML( 'beforeend', `<div class="ps">${ getName( [
	// 	'Кроме прочего, у нас всегда можно заказать все базовые и классические коктейли, а так же шоты.<br />Уточняйте у официантов.',
	// 	'Among other things, you can always order all basic and classic cocktails, as well as shots.<br />Check with waiters.',
	// ] ) }</div>` );

	page[ 0 ].appendChild( colon[ 0 ].cloneNode( true ) );
	page[ 0 ].appendChild( colon[ 0 ].cloneNode( true ) );
	page[ 0 ].appendChild( colon[ 0 ].cloneNode( true ) );

	page[ 1 ].appendChild( colon[ 1 ].cloneNode( true ) );
	page[ 1 ].appendChild( colon[ 1 ].cloneNode( true ) );
	page[ 1 ].appendChild( colon[ 1 ].cloneNode( true ) );

</script>

</body>

</html>